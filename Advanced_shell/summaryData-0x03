#!/bin/bash

# PokÃ©mon data summary script
# Reads JSON files and generates a CSV report with averages

# Check if pokemon_data directory exists
if [ ! -d "pokemon_data" ]; then
    echo "Error: pokemon_data directory not found. Please run the batch processing script first."
    exit 1
fi

# Output CSV file
CSV_FILE="pokemon_report.csv"

# Clear/create the CSV file and add header
echo "Name,Height (m),Weight (kg)" > "$CSV_FILE"

# Initialize variables for calculating averages
total_height=0
total_weight=0
count=0

echo "Processing PokÃ©mon data files..."

# Process each JSON file in the pokemon_data directory
for json_file in pokemon_data/*.json; do
    if [ -f "$json_file" ]; then
        # Extract PokÃ©mon name from filename (remove path and .json extension)
        pokemon_name=$(basename "$json_file" .json)
        
        # Extract height and weight using jq
        height=$(jq -r '.height' "$json_file")
        weight=$(jq -r '.weight' "$json_file")
        
        # Convert units: height from decimeters to meters, weight from hectograms to kilograms
        height_m=$(echo "scale=2; $height / 10" | bc -l)
        weight_kg=$(echo "scale=2; $weight / 10" | bc -l)
        
        # Capitalize first letter of PokÃ©mon name
        pokemon_name_cap=$(echo "$pokemon_name" | awk '{print toupper(substr($0,1,1)) substr($0,2)}')
        
        # Add data to CSV
        echo "$pokemon_name_cap,$height_m,$weight_kg" >> "$CSV_FILE"
        
        # Accumulate for averages
        total_height=$(echo "$total_height + $height_m" | bc -l)
        total_weight=$(echo "$total_weight + $weight_kg" | bc -l)
        count=$((count + 1))
        
        echo "Processed: $pokemon_name_cap (Height: ${height_m}m, Weight: ${weight_kg}kg)"
    fi
done

# Calculate averages using awk
echo ""
echo "CSV Report generated at: $CSV_FILE"
echo ""

# Display the CSV content
cat "$CSV_FILE"

echo ""

# Calculate and display averages
if [ $count -gt 0 ]; then
    avg_height=$(echo "scale=2; $total_height / $count" | bc -l)
    avg_weight=$(echo "scale=2; $total_weight / $count" | bc -l)
    
    echo "Average Height: $avg_height m"
    echo "Average Weight: $avg_weight kg"
else
    echo "No PokÃ©mon data found to process."
fi

echo ""
echo "ðŸŽ‰ PokÃ©mon summary report completed!"
